name: Lululemon Monitor

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Download previous state (if exists)
        uses: actions/download-artifact@v4
        with:
          name: monitor-state
          path: .
          continue-on-error: true

      - name: Create config file
        env:
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          python -c "
          import json
          import os
          
          # Load product URLs
          with open('urls.json', 'r') as f:
              products = json.load(f)
          
          # Create config
          config = {
              'check_interval_minutes': 30,
              'debug': False,
              'email': {
                  'from': os.getenv('EMAIL_FROM'),
                  'to': os.getenv('EMAIL_TO'),
                  'password': os.getenv('EMAIL_PASSWORD'),
                  'use_smtp': False
              },
              'products': [
                  {
                      'url': p['url'],
                      'max_price': 60,
                      'name': p['name']
                  }
                  for p in products
              ]
          }
          
          with open('config.json', 'w') as f:
              json.dump(config, f, indent=2)
          "

      - name: Run monitor
        run: |
          python monitor.py --run-once

      - name: Upload state file (persist state between runs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-state
          path: monitor_state.json
          retention-days: 90
          if-no-files-found: ignore
